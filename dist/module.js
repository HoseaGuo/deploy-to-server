import e from"draftlog";import t from"archiver";import{NodeSSH as n}from"node-ssh";import{exit as r}from"process";import o from"chalk";function c(e,t,n,r){return new(n||(n=Promise))((function(o,c){function i(e){try{s(r.next(e))}catch(e){c(e)}}function a(e){try{s(r.throw(e))}catch(e){c(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}s((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,o,c,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return c={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function a(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}var a=require("fs");require("path"),e(console);var s=new n,u="./dist",l="/data/www/test",f=!0,p="_dist.zip",d={};function h(){return c(this,void 0,void 0,(function(){var e,n,r;return i(this,(function(o){return e=a.createWriteStream("./"+d.zipFileame),(n=t("zip",{zlib:{level:9}})).pipe(e),n.directory(u,!1),n.finalize(),r=g("本地打包文件压缩"),[2,new Promise((function(t,o){n.on("error",(function(e){console.log(e),o(e)})),e.on("close",(function(){r(),t(!0)}))}))]}))}))}function m(){return c(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:e=g("上传打包文件到远程"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,s.putFile(d.zipFileame,"/data/www/test/".concat(d.zipFileame))];case 2:return n.sent(),e(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return[2]}}))}))}function v(){return c(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:e=g("删除远程源文件"),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,s.execCommand("cd ".concat(l),{cwd:l})];case 2:return n.sent(),[4,s.execCommand("rm `find ./* |egrep -v 'node_modules'` -rf",{cwd:l})];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),console.log(t),e(!1),[3,5];case 5:return e(),[2]}}))}))}function b(){return c(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:e=g("解压远程压缩文件及删除"),n.label=1;case 1:return n.trys.push([1,5,,6]),[4,s.execCommand("cd ".concat(l),{cwd:l})];case 2:return n.sent(),[4,s.execCommand("unzip -o ".concat(d.zipFileame," -d ."),{cwd:l})];case 3:return n.sent(),[4,s.execCommand("rm ".concat(d.zipFileame),{cwd:l})];case 4:return n.sent(),[3,6];case 5:return t=n.sent(),console.log(t),e(!1),[3,6];case 6:return e(),[2]}}))}))}function w(){return c(this,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:e=g("远程安装npm包"),s.execCommand("cd ".concat(l),{cwd:l}),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,s.execCommand("npm i",{cwd:l})];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return e(),[2]}}))}))}function g(e){var t=process.hrtime.bigint(),n=["-","\\","|","/"],c=0,i=console.draft(e+n[c]),a=setInterval((function(){i("[".concat(n[c=(c+1)%n.length],"] ").concat(e))}),50);return function(n){if(void 0===n&&(n=!0),clearInterval(a),n){var c=process.hrtime.bigint();i(o.rgb(92,175,158)("[√] ".concat(e," "))+o.whiteBright(y(c-t)))}else i(o.red("[×] ".concat(e))),r(1)}}function y(e){return(e=Number(e))<1e3||e<Math.pow(1e3,2)?"".concat((e/1e3).toFixed(3),"ms"):(Math.pow(1e3,3),"".concat((e/Math.pow(1e3,3)).toFixed(3),"s"))}function x(e){var t=e.distPath,n=e.serverPath,r=e.installNpmPackage,x=e.zipFileame,z=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["distPath","serverPath","installNpmPackage","zipFileame"]);d={distPath:t||u,serverPath:n||l,installNpmPackage:r||f,zipFileame:x||p};var P=process.hrtime.bigint();console.log(o.rgb(25,181,255)("开始部署>>>"));var F=g("ssh连接服务器");s.connect(z).then((function(){return c(this,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return F(),[4,v()];case 1:return t.sent(),[4,h()];case 2:return t.sent(),[4,m()];case 3:return t.sent(),[4,c(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e,t){var n=g("删除本地zip包");a.unlink(d.zipFileame,(function(t){t&&(console.log(t),n(!1)),n(),e(!0)}))}))]}))}))];case 4:return t.sent(),[4,b()];case 5:return t.sent(),[4,w()];case 6:t.sent(),t.label=7;case 7:return s.dispose(),e=process.hrtime.bigint(),console.log(o.rgb(25,181,255)("<<<结束部署")),console.log(o.rgb(255,189,75)("Total time: "+y(e-P))),[2]}}))}))})).catch((function(e){console.log(e),F(!1)}))}export{x as default};
