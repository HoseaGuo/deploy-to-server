"use strict";var e=require("draftlog"),t=require("archiver"),n=require("node-ssh"),r=require("process"),o=require("chalk");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=a(e),i=a(t),s=a(o);function u(e,t,n,r){return new(n||(n=Promise))((function(o,a){function c(e){try{s(r.next(e))}catch(e){a(e)}}function i(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,i)}s((r=r.apply(e,t||[])).next())}))}function l(e,t){var n,r,o,a,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,r=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){c=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){c.label=a[1];break}if(6===a[0]&&c.label<o[1]){c.label=o[1],o=a;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(a);break}o[2]&&c.ops.pop(),c.trys.pop();continue}a=t.call(e,c)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}var f=require("fs");require("path"),c.default(console);var d=new n.NodeSSH,h="./dist",p="/data/www/test",v=!0,m="_dist.zip",b={};function w(){return u(this,void 0,void 0,(function(){var e,t,n;return l(this,(function(r){return e=f.createWriteStream("./"+b.zipFileame),(t=i.default("zip",{zlib:{level:9}})).pipe(e),t.directory(b.distPath,!1),t.finalize(),n=z("本地打包文件压缩"),[2,new Promise((function(r,o){t.on("error",(function(e){console.log(e),o(e)})),e.on("close",(function(){n(),r(!0)}))}))]}))}))}function g(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=z("上传打包文件到远程"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,d.putFile(b.zipFileame,"/data/www/test/".concat(b.zipFileame))];case 2:return n.sent(),e(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return[2]}}))}))}function y(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=z("删除远程源文件"),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,d.execCommand("cd ".concat(b.serverPath),{cwd:b.serverPath})];case 2:return n.sent(),[4,d.execCommand("rm `find ./* |egrep -v 'node_modules'` -rf",{cwd:b.serverPath})];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),console.log(t),e(!1),[3,5];case 5:return e(),[2]}}))}))}function P(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=z("解压远程压缩文件及删除"),n.label=1;case 1:return n.trys.push([1,5,,6]),[4,d.execCommand("cd ".concat(b.serverPath),{cwd:b.serverPath})];case 2:return n.sent(),[4,d.execCommand("unzip -o ".concat(b.zipFileame," -d ."),{cwd:b.serverPath})];case 3:return n.sent(),[4,d.execCommand("rm ".concat(b.zipFileame),{cwd:b.serverPath})];case 4:return n.sent(),[3,6];case 5:return t=n.sent(),console.log(t),e(!1),[3,6];case 6:return e(),[2]}}))}))}function x(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=z("远程安装npm包"),d.execCommand("cd ".concat(b.serverPath),{cwd:b.serverPath}),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,d.execCommand("npm i",{cwd:b.serverPath})];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return e(),[2]}}))}))}function z(e){var t=process.hrtime.bigint(),n=["-","\\","|","/"],o=0,a=console.draft(e+n[o]),c=setInterval((function(){a("[".concat(n[o=(o+1)%n.length],"] ").concat(e))}),50);return function(n){if(void 0===n&&(n=!0),clearInterval(c),n){var o=process.hrtime.bigint();a(s.default.rgb(92,175,158)("[√] ".concat(e," "))+s.default.whiteBright(F(o-t)))}else a(s.default.red("[×] ".concat(e))),r.exit(1)}}function F(e){return(e=Number(e))<1e3||e<Math.pow(1e3,2)?"".concat((e/1e3).toFixed(3),"ms"):(Math.pow(1e3,3),"".concat((e/Math.pow(1e3,3)).toFixed(3),"s"))}module.exports=function(e){var t=e.distPath,n=e.serverPath,r=e.installNpmPackage,o=e.zipFileame,a=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["distPath","serverPath","installNpmPackage","zipFileame"]);b={distPath:t||h,serverPath:n||p,installNpmPackage:r||v,zipFileame:o||m};var c=process.hrtime.bigint();console.log(s.default.rgb(25,181,255)("开始部署>>>"));var i=z("ssh连接服务器");d.connect(a).then((function(){return u(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:return i(),[4,y()];case 1:return t.sent(),[4,w()];case 2:return t.sent(),[4,g()];case 3:return t.sent(),[4,u(void 0,void 0,void 0,(function(){return l(this,(function(e){return[2,new Promise((function(e,t){var n=z("删除本地zip包");f.unlink(b.zipFileame,(function(t){t&&(console.log(t),n(!1)),n(),e(!0)}))}))]}))}))];case 4:return t.sent(),[4,P()];case 5:return t.sent(),b.installNpmPackage?[4,x()]:[3,7];case 6:t.sent(),t.label=7;case 7:return d.dispose(),e=process.hrtime.bigint(),console.log(s.default.rgb(25,181,255)("<<<结束部署")),console.log(s.default.rgb(255,189,75)("Total time: "+F(e-c))),[2]}}))}))})).catch((function(e){console.log(e),i(!1)}))};
