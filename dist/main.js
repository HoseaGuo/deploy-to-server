"use strict";var e=require("draftlog"),t=require("archiver"),n=require("node-ssh"),r=require("process"),o=require("chalk");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=c(e),a=c(t),s=c(o);function u(e,t,n,r){return new(n||(n=Promise))((function(o,c){function i(e){try{s(r.next(e))}catch(e){c(e)}}function a(e){try{s(r.throw(e))}catch(e){c(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}s((r=r.apply(e,t||[])).next())}))}function l(e,t){var n,r,o,c,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return c={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function a(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,r=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){i.label=c[1];break}if(6===c[0]&&i.label<o[1]){i.label=o[1],o=c;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(c);break}o[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}var f=require("fs");require("path"),i.default(console);var d=new n.NodeSSH,p="./dist",h="/data/www/test",v=!0,m="_dist.zip",b={};function w(){return u(this,void 0,void 0,(function(){var e,t,n;return l(this,(function(r){return e=f.createWriteStream("./"+b.zipFileame),(t=a.default("zip",{zlib:{level:9}})).pipe(e),t.directory(p,!1),t.finalize(),n=P("本地打包文件压缩"),[2,new Promise((function(r,o){t.on("error",(function(e){console.log(e),o(e)})),e.on("close",(function(){n(),r(!0)}))}))]}))}))}function g(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=P("上传打包文件到远程"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,d.putFile(b.zipFileame,"/data/www/test/".concat(b.zipFileame))];case 2:return n.sent(),e(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return[2]}}))}))}function y(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=P("删除远程源文件"),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,d.execCommand("cd ".concat(h),{cwd:h})];case 2:return n.sent(),[4,d.execCommand("rm `find ./* |egrep -v 'node_modules'` -rf",{cwd:h})];case 3:return n.sent(),[3,5];case 4:return t=n.sent(),console.log(t),e(!1),[3,5];case 5:return e(),[2]}}))}))}function x(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=P("解压远程压缩文件及删除"),n.label=1;case 1:return n.trys.push([1,5,,6]),[4,d.execCommand("cd ".concat(h),{cwd:h})];case 2:return n.sent(),[4,d.execCommand("unzip -o ".concat(b.zipFileame," -d ."),{cwd:h})];case 3:return n.sent(),[4,d.execCommand("rm ".concat(b.zipFileame),{cwd:h})];case 4:return n.sent(),[3,6];case 5:return t=n.sent(),console.log(t),e(!1),[3,6];case 6:return e(),[2]}}))}))}function z(){return u(this,void 0,void 0,(function(){var e,t;return l(this,(function(n){switch(n.label){case 0:e=P("远程安装npm包"),d.execCommand("cd ".concat(h),{cwd:h}),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,d.execCommand("npm i",{cwd:h})];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),console.log(t),e(!1),[3,4];case 4:return e(),[2]}}))}))}function P(e){var t=process.hrtime.bigint(),n=["-","\\","|","/"],o=0,c=console.draft(e+n[o]),i=setInterval((function(){c("[".concat(n[o=(o+1)%n.length],"] ").concat(e))}),50);return function(n){if(void 0===n&&(n=!0),clearInterval(i),n){var o=process.hrtime.bigint();c(s.default.rgb(92,175,158)("[√] ".concat(e," "))+s.default.whiteBright(F(o-t)))}else c(s.default.red("[×] ".concat(e))),r.exit(1)}}function F(e){return(e=Number(e))<1e3||e<Math.pow(1e3,2)?"".concat((e/1e3).toFixed(3),"ms"):(Math.pow(1e3,3),"".concat((e/Math.pow(1e3,3)).toFixed(3),"s"))}module.exports=function(e){var t=e.distPath,n=e.serverPath,r=e.installNpmPackage,o=e.zipFileame,c=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(e,["distPath","serverPath","installNpmPackage","zipFileame"]);b={distPath:t||p,serverPath:n||h,installNpmPackage:r||v,zipFileame:o||m};var i=process.hrtime.bigint();console.log(s.default.rgb(25,181,255)("开始部署>>>"));var a=P("ssh连接服务器");d.connect(c).then((function(){return u(this,void 0,void 0,(function(){var e;return l(this,(function(t){switch(t.label){case 0:return a(),[4,y()];case 1:return t.sent(),[4,w()];case 2:return t.sent(),[4,g()];case 3:return t.sent(),[4,u(void 0,void 0,void 0,(function(){return l(this,(function(e){return[2,new Promise((function(e,t){var n=P("删除本地zip包");f.unlink(b.zipFileame,(function(t){t&&(console.log(t),n(!1)),n(),e(!0)}))}))]}))}))];case 4:return t.sent(),[4,x()];case 5:return t.sent(),[4,z()];case 6:t.sent(),t.label=7;case 7:return d.dispose(),e=process.hrtime.bigint(),console.log(s.default.rgb(25,181,255)("<<<结束部署")),console.log(s.default.rgb(255,189,75)("Total time: "+F(e-i))),[2]}}))}))})).catch((function(e){console.log(e),a(!1)}))};
